<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FFJ Rider - Live Tracking</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<style>
body{font-family:sans-serif;background:#f9fafb;}
#map{height:400px;width:100%;border-radius:10px;}
.btn{background:#16a34a;color:white;padding:8px 12px;border-radius:6px;}
.btn:hover{background:#15803d;}
.card{background:white;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1);padding:1rem;}
</style>
</head>
<body>
<nav class="flex justify-between items-center p-4 bg-green-600 text-white">
  <h1 class="font-bold text-xl">FFJ Rider</h1>
  <button class="bg-red-600 px-3 py-1 rounded" onclick="logout()">Logout</button>
</nav>

<main class="p-6">
  <h2 class="text-2xl font-bold mb-4">My Active Order</h2>
  <div id="orderCard" class="card mb-4"></div>
  <div id="map"></div>
  <p id="status" class="mt-4 text-gray-600"></p>
  <button id="startBtn" class="btn mt-4" onclick="startTracking()">Start Tracking</button>
</main>

<!-- Socket.io + Google Maps -->
<script src="http://localhost:4000/socket.io/socket.io.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>
<script>
const API = "http://localhost:4000";
const token = localStorage.getItem("token");
if (!token) location = "login.html";

const socket = io(API);
let activeOrder = null;
let map, marker;

axios.get(API + "/orders", { headers: { Authorization: `Bearer ${token}` } })
  .then(res => {
    const order = res.data.find(o => o.orderStatus !== "delivered" && o.riderId);
    const div = document.getElementById("orderCard");
    if (!order) return div.innerHTML = "<p>No active order.</p>";
    activeOrder = order._id;
    div.innerHTML = `<h3 class="font-semibold">Order #${order._id}</h3>
      <p>Status: ${order.orderStatus}</p>
      <p>Total: ₦${order.totalAmount}</p>`;
    socket.emit("joinAsRider", { orderId: activeOrder });
  });

function initMap(lat=6.5244, lng=3.3792) {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat, lng }, zoom: 14
  });
  marker = new google.maps.Marker({
    position: { lat, lng },
    map,
    title: "You",
    icon: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"
  });
}

function startTracking() {
  if (!activeOrder) return alert("No active order found!");
  if (!navigator.geolocation) return alert("Geolocation not supported.");
  initMap();
  alert("Live tracking started!");
  navigator.geolocation.watchPosition(
    pos => {
      const { latitude, longitude } = pos.coords;
      marker.setPosition({ lat: latitude, lng: longitude });
      map.panTo({ lat: latitude, lng: longitude });
      document.getElementById("status").innerText = `📍 Lat: ${latitude.toFixed(5)}, Lng: ${longitude.toFixed(5)}`;
      socket.emit("riderLocation", { orderId: activeOrder, lat: latitude, lng: longitude });
    },
    err => console.error(err),
    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
  );
}

function logout() {
  localStorage.removeItem("token");
  location = "login.html";
}
</script>
</body>
</html>